name: CI/CD MLOps Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "model.py"
      - "model.onnx"
      - "Dockerfile"
      - "requirements.txt"
      - ".github/workflows/main.yml"

permissions:
  contents: read
  packages: write
  security-events: write  # For Trivy SARIF upload

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_TOKEN_2 }}

      - name: Set up QEMU (for multi-arch builds)
        uses: docker/setup-qemu-action@v3

      - name: Build and Push Docker Image (Multi-arch)
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          REPO_OWNER_LOWERCASE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/$REPO_OWNER_LOWERCASE/ml-model"

          # Build and push multi-arch image (amd64 + arm64)
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t $IMAGE_NAME:$IMAGE_TAG \
            -t $IMAGE_NAME:latest \
            --push \
            .

          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # Pull image for local scanning (single arch for Trivy)
      - name: Pull image for scanning
        run: |
          docker pull ${{ steps.build-image.outputs.image_name }}:${{ steps.build-image.outputs.image_tag }}

      # ============================================
      # SECURITY: Trivy Container Vulnerability Scan
      # ============================================
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.build-image.outputs.image_name }}:${{ steps.build-image.outputs.image_tag }}'
          format: 'table'
          exit-code: '0'  # Don't fail build, just report (change to '1' for strict mode)
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy scanner (SARIF output for GitHub Security)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.build-image.outputs.image_name }}:${{ steps.build-image.outputs.image_tag }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # Note: Image already pushed during buildx build step (multi-arch)

      # ------------------------------------------------------------------
      # GITOPS: Update deployment manifest
      # ------------------------------------------------------------------
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: Tomo1912/my-mlops-gitops
          path: gitops-repo
          token: ${{ secrets.PAT_TOKEN_2 }}

      - name: Update Image Tag in manifest
        run: |
          IMAGE_NAME="${{ steps.build-image.outputs.image_name }}"
          IMAGE_TAG="${{ steps.build-image.outputs.image_tag }}"
          FULL_IMAGE="$IMAGE_NAME:$IMAGE_TAG"

          # Update any existing image reference
          sed -i "s|REPLACE_ME_IMAGE_PATH/ml-model:v1.0.0|$FULL_IMAGE|g" gitops-repo/deployment.yaml

      - name: Commit and Push to GitOps Repo
        run: |
          cd gitops-repo
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add deployment.yaml

          IMAGE_NAME="${{ steps.build-image.outputs.image_name }}"
          IMAGE_TAG="${{ steps.build-image.outputs.image_tag }}"

          git commit -m "chore(gitops): update image to $IMAGE_NAME:$IMAGE_TAG [security-scanned]" || true
          git push
