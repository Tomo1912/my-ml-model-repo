name: CI/CD MLOps Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "model.py"
      - "Dockerfile"
      - "requirements.txt"

permissions:
  contents: read
  packages: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_TOKEN_2 }}

      - name: Build and Push Docker Image
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # POPRAVAK ZA GHCR (mala slova)
          REPO_OWNER_LOWERCASE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')

          IMAGE_NAME="ghcr.io/$REPO_OWNER_LOWERCASE/ml-model"

          docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest

          echo "image_url=$IMAGE_NAME:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # GITOPS KORAK: Ažuriranje drugog repozitorija
      # ------------------------------------------------------------------
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          repository: Tomo1912/my-mlops-gitops
          path: gitops-repo
          token: ${{ secrets.PAT_TOKEN_2 }}

      - name: Replace Image Tag in manifest
        run: |
          LATEST_IMAGE=${{ steps.build-image.outputs.image_url }}

          # Mijenjamo placeholder 'REPLACE_ME_IMAGE_PATH/ml-model:v1.0.0' sa novim Image URL-om
          # NAPOMENA: Ako je placeholder već izbrisan, sed neće ništa promijeniti, što je u redu.
          sed -i "s|REPLACE_ME_IMAGE_PATH/ml-model:v1.0.0|$LATEST_IMAGE|g" gitops-repo/deployment.yaml

      - name: Commit and Push to GitOps Repo
        run: |
          cd gitops-repo
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add deployment.yaml

          # POPRAVAK ZA GREŠKU: Ako nema promjene, nastavi (|| true)
          git commit -m "chore(gitops): update image to $LATEST_IMAGE" || true

          git push
        env:
          LATEST_IMAGE: ${{ steps.build-image.outputs.image_url }}
