name: CI/CD MLOps Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "model.py"
      - "Dockerfile"
      - "requirements.txt"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # KORISTITE SECRET ZA VAŠ PAT TOKEN (kreiramo ga u koraku C)
          password: ${{ secrets.PAT_TOKEN }}

      - name: Build and Push Docker Image
        id: build-image
        env:
          # Koristimo SHA commita kao jedinstveni TAG
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/ml-model"

          # Build image i push na GHCR (GitHub Container Registry)
          docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest

          # Postavljamo output varijablu za kasniju upotrebu (image_url)
          echo "image_url=$IMAGE_NAME:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # GITOPS KORAK: Ažuriranje drugog repozitorija
      # ------------------------------------------------------------------
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          # Repozitorij koji želimo ažurirati
          repository: Tomo1912/my-mlops-gitops
          path: gitops-repo
          token: ${{ secrets.PAT_TOKEN }} # PAT za write pristup

      - name: Replace Image Tag in manifest
        run: |
          LATEST_IMAGE=${{ steps.build-image.outputs.image_url }}

          # Koristimo sed za zamjenu placeholder putanje s novim image tagom!
          # Mijenjamo 'REPLACE_ME_IMAGE_PATH/ml-model:v1.0.0' sa novim, punim image URL-om.
          sed -i "s|REPLACE_ME_IMAGE_PATH/ml-model:v1.0.0|$LATEST_IMAGE|g" gitops-repo/deployment.yaml

      - name: Commit and Push to GitOps Repo
        run: |
          cd gitops-repo
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add deployment.yaml
          git commit -m "chore(gitops): update image to $LATEST_IMAGE"
          git push
        env:
          LATEST_IMAGE: ${{ steps.build-image.outputs.image_url }}
